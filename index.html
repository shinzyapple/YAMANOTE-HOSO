<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>外部設定で音声再生</title>
</head>
<body>
  <h2>カメラ映像から文字検出</h2>
  <video id="video" width="400" height="300" autoplay playsinline></video>
  <canvas id="canvas" width="400" height="300" style="display:none;"></canvas>
  <p id="result">検出結果: </p>

  <audio id="audio" src="" preload="auto"></audio>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const result = document.getElementById('result');
    const audio = document.getElementById('audio');

    let wordMap = {};               // 外部から読み込む単語と音声のマッピング
    const detectedWords = new Set(); // 重複検出防止

    // カメラ起動
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
    }).catch(err => {
      alert("カメラにアクセスできません: " + err);
    });

    // 外部JSONを読み込む
    fetch('words.json')
      .then(response => response.json())
      .then(data => {
        wordMap = data;
        startOCR(); // OCR開始
      })
      .catch(err => {
        alert("単語設定ファイルの読み込みに失敗しました: " + err);
      });

    function startOCR() {
      setInterval(() => {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        Tesseract.recognize(canvas, 'jpn', {
          logger: m => console.log(m)
        }).then(({ data: { text } }) => {
          result.innerText = "検出結果: " + text;

          for (const word in wordMap) {
            if (text.includes(word) && !detectedWords.has(word)) {
              detectedWords.add(word);
              playAudio(wordMap[word]);
              break;
            }
          }
        });
      }, 4000);
    }

    function playAudio(filePath) {
      audio.src = filePath;
      audio.play().catch(err => {
        console.log("音声再生エラー:", err);
      });
    }
  </script>
</body>
</html>
